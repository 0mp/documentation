

\section{DTrace Components}

There are three main components of DTrace, the kernel module, a set of providers and the DTrace command line utility (DTrace CLI). The kernel module and providers run in kernel mode and are responsible for collecting data specified by the instrumentation and transmitting it back to userland. The DTrace CLI is the users interface to instrument the system providing the mechanisms for specifying instrumentation and displaying the results. Each component is discussed in greater detail in the following sections.

\subsection{Kernel Module}

The DTrace kernel model is the heart of the DTrace framework. This module is responsible for the coordination of all other components use in instrumentation. It keeps track of all registered providers and informs them when to enable or disable their probes. When a providers probe fires, the DTrace kernel module is responsible for executing the necessary instrumentation code and providing the data its consumers.

The kernel module is also the intermediary between the DTrace User interface and the providers. When compiling user scripts, the kernel module provides the D compiler with probe arguments and types. Once compiled, scripts are handed off to the module as Enabling Code Blocks (ECBs) to be executed as probes first. Once executed, the data is handed back to the user interface for display to the end user.

\subsection{Provider}

% Responsibilities
	% Provides DTrace probe points
	% Registers itself with DTrace when available
	% Tracks when probes are enabled
	% Calls kernel model when probe is reached	

% Discuss providers supplied by DTrace and when/how they are loaded
% Discuss custom providers  

\subsection{DTrace CLI}

% Responsibilities
	% Userland interface
	% Accepts and compiles D scripts
	% Provides ECBs to framework to be run when probes reached
	% Provides buffers to framework for instrumentation data
	% Displays instrumentation results

\section{Typical DTrace Life Cycle}

% Life cycle figure goes here

The life cycle a generic example of instrumentation with DTrace is giving in Figure \ref{fig:lifecycle}. For the purposes of this example it is assumed that the DTrace kernel module has already been loaded (usually at boot). Built in DTrace providers are commonly loaded alongside the kernel module, so the example considers a generic provider loaded sometime after boot.

% Narrative on the life cycle of an instrumentation
	% DTrace Kernel Module is loaded
	% Audit Kernel Module Loaded
		% Registers provider with kernel model
	% Script is input into CLI triggering instrumentation
		% Script is compiled by CLI
			% Request made for probe argument descriptions
				% via ioctls
			% Kernel module confirms provider provides probe
				% TODO Double Check under which conditions
			% Kernel module queries provider for argument type
			% Kernel provides argument descriptions
				% TODO Check how description are returned
		% ECB is generated and provided to kernel module
	% Kernel module tells provider to enable instrumented probes
	% When instrumented event occurs provider calls dtrace_probe function
		% Kernel module processes the ECBs
		% Resulting data is placed in buffer of CLI instance corresponding to ECB
		% CLI reads data from the buffer and displays results
			% TODO Double check where final display format is processed



